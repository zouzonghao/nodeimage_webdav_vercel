document.addEventListener("DOMContentLoaded",()=>{let e=document.getElementById("incremental-sync-btn"),t=document.getElementById("full-sync-btn"),o=document.getElementById("cookie-input"),n=document.getElementById("save-cookie-btn"),i=document.getElementById("sync-action-message"),c=document.getElementById("config-action-message"),a=document.getElementById("log-container"),r=document.getElementById("clear-log-btn"),s;function l(){let e="https:"===window.location.protocol?"wss:":"ws:";(s=new WebSocket(`${e}//${window.location.host}/ws`)).onopen=()=>{g("WebSocket 连接成功","info"),k()},s.onmessage=e=>{let t=JSON.parse(e.data);switch(t.type){case"log":let o=document.createElement("p");o.innerHTML=t.content,a.appendChild(o),a.scrollTop=a.scrollHeight;break;case"syncStatus":d("syncing"===t.content)}},s.onclose=()=>{g("WebSocket 连接断开，3秒后尝试重连...","error"),setTimeout(l,3e3)},s.onerror=e=>{console.error("WebSocket error:",e),g("WebSocket 连接错误","error")}}function d(o){e.disabled=o,t.disabled=o,n.disabled=o,o?(e.textContent="增量同步中...",t.textContent="全量同步中..."):(e.textContent="增量同步 (API Key)",t.textContent="全量同步 (Cookie)")}function y(e,t,o){e.textContent=t,e.className=`action-message msg-${o}`,e.style.display="block",setTimeout(()=>{e.style.display="none"},3e3)}function g(e,t){let o=document.createElement("p");o.className=`log-${t.toUpperCase()}`,o.textContent=`[${new Date().toLocaleTimeString()}] [${t.toUpperCase()}] ${e}`,a.appendChild(o),a.scrollTop=a.scrollHeight}async function p(e=!1){let t="/api/sync";e&&(t+="?mode=full");try{let o=await fetch(t,{method:"POST"});if(!o.ok)throw Error(`HTTP error! status: ${o.status}`)}catch(n){console.error("Failed to trigger sync:",n),y(i,"启动同步失败","error")}}async function k(){try{let e=await fetch("/api/config"),t=await e.json();o.placeholder=t.isCookieSet?"后端已配置 Cookie，可在此处覆盖":"后端未配置 Cookie，请在此处输入"}catch(n){console.error("Failed to check cookie status:",n)}}async function m(){let e=o.value.trim();if(!e){y(c,"Cookie 不能为空","error");return}try{let t=await fetch("/api/config",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({cookie:e})});if(t.ok)y(c,"Cookie 已成功在后端更新","success");else throw Error("Failed to save cookie")}catch(n){console.error("Failed to save cookie:",n),y(c,"保存 Cookie 失败","error")}}e.addEventListener("click",()=>p(!1)),t.addEventListener("click",()=>p(!0)),n.addEventListener("click",m),r.addEventListener("click",()=>{a.innerHTML="",g("日志已清除","info")}),l()});
