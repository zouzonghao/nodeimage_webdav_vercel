document.addEventListener("DOMContentLoaded",async()=>{await l();let e=document.getElementById("incremental-sync-btn"),t=document.getElementById("full-sync-btn"),o=document.getElementById("cookie-input"),n=document.getElementById("save-cookie-btn"),a=document.getElementById("sync-action-message"),i=document.getElementById("config-action-message"),c=document.getElementById("log-container"),r=document.getElementById("clear-log-btn"),s;async function l(){try{let e=await fetch("/api/check-auth"),t=await e.json();t.authenticated||(window.location.href="/login.html")}catch(o){console.error("Authentication check failed:",o)}}function d(){let e="https:"===window.location.protocol?"wss:":"ws:";(s=new WebSocket(`${e}//${window.location.host}/ws`)).onopen=()=>{k("WebSocket 连接成功","info"),h()},s.onmessage=e=>{let t=JSON.parse(e.data);switch(t.type){case"log":let o=document.createElement("p");o.innerHTML=t.content,c.appendChild(o),c.scrollTop=c.scrollHeight;break;case"syncStatus":y("syncing"===t.content)}},s.onclose=()=>{k("WebSocket 连接断开，3秒后尝试重连...","error"),setTimeout(d,3e3)},s.onerror=e=>{console.error("WebSocket error:",e),k("WebSocket 连接错误","error")}}function y(o){e.disabled=o,t.disabled=o,n.disabled=o,o?(e.textContent="增量同步中...",t.textContent="全量同步中..."):(e.textContent="增量同步 (API Key)",t.textContent="全量同步 (Cookie)")}function g(e,t,o){e.textContent=t,e.className=`action-message msg-${o}`,e.style.display="block",setTimeout(()=>{e.style.display="none"},3e3)}function k(e,t){let o=document.createElement("p");o.className=`log-${t.toUpperCase()}`,o.textContent=`[${new Date().toLocaleTimeString()}] [${t.toUpperCase()}] ${e}`,c.appendChild(o),c.scrollTop=c.scrollHeight}async function p(e=!1){let t="/api/sync";e&&(t+="?mode=full");try{let o=await fetch(t,{method:"POST"});if(!o.ok)throw Error(`HTTP error! status: ${o.status}`)}catch(n){console.error("Failed to trigger sync:",n),g(a,"启动同步失败","error")}}async function h(){try{let e=await fetch("/api/config"),t=await e.json();o.placeholder=t.isCookieSet?"后端已配置 Cookie，可在此处覆盖":"后端未配置 Cookie，请在此处输入"}catch(n){console.error("Failed to check cookie status:",n)}}async function m(){let e=o.value.trim();if(!e){g(i,"Cookie 不能为空","error");return}try{let t=await fetch("/api/config",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({cookie:e})});if(t.ok)g(i,"Cookie 已成功在后端更新","success");else throw Error("Failed to save cookie")}catch(n){console.error("Failed to save cookie:",n),g(i,"保存 Cookie 失败","error")}}e.addEventListener("click",()=>p(!1)),t.addEventListener("click",()=>p(!0)),n.addEventListener("click",m),r.addEventListener("click",()=>{c.innerHTML="",k("日志已清除","info")}),d()});